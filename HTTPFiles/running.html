<html>
    <head>
        <title>AntGame!</title>
        <style>

h1{
    text-align: center;
    color: white;
}
body{
    background-color: black;
}
p, ul{
    color: white;
}

        </style>
        <script>
refreshData();
fetch("internalMapData").then((response) => {
        if (!response.ok)
        {
            let ctx = document.getElementById("MapCanvas").getContext("2d");
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, __WIDTH, __HEIGHT);
            ctx.fillStyle = "#000000";
            ctx.font = "12px Arial";
            ctx.fillText("Failed to get map data.", 0, 0);
            return null;
        }
        return response.text();
        }).then(fillinMap);
const colors = [[255, 255, 255], [0, 0, 0], [255, 0, 0], [0, 255, 0]];
const antColor = [0, 0, 255];
const hexString = "0123456789abcdef";
let baseImgData;
let changelogPoint = 0;

function refreshData()
{
    let playerList = document.getElementById("PlayerList");
    fetch("playerData").then((response) => {
        if (!response.ok)
        {
            playerList.textContent = "Server failed to tell how many players are here.";
            setTimeout(refreshData, 1000);
            return null;
        }
        return response.text();
        }).then(fillinData);
}

function refreshMap()
{
    fetch("changelogMapData" + changelogPoint.toString()).then((response) => {
        if (response.ok)
        {
            return response.bytes();
        }
        return null;
    }).then(updateMap);
}

function fillinData(text)
{
    if (text == "SIR_IT_IS_TIME_TO_REFRESH")
    {
        window.location.reload();
    }
    let playerList = document.getElementById("PlayerList");
    playerList.innerHTML = text;
    setTimeout(refreshData, 1000);
}

function fillinMap(response)
{
    let ctx = document.getElementById("MapCanvas").getContext("2d");
    let data = response.toLowerCase();
    ctx.fillRect(0, 0, 1000, 1000);
    let imgdata = ctx.getImageData(0, 0, __WIDTH, __HEIGHT);
    let isFirst = true;
    let num = 0;
    changelogPoint = 0;
    if (hexString.includes(data[0]) && hexString.includes(data[2]) && hexString.includes(data[3]) && hexString.includes(data[4]) && hexString.includes(data[1]) && hexString.includes(data[5]) && hexString.includes(data[6]) && hexString.includes(data[7]))
    {
        changelogPoint += hexString.indexOf(data[0]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[1]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[2]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[3]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[4]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[5]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[6]);
        changelogPoint *= 16;
        changelogPoint += hexString.indexOf(data[7]);
    }
    for (let i = 8; i < data.length; i++)
    {
        num *= 16;
        if (hexString.includes(data[i]))
        {num += hexString.indexOf(data[i]);}
        isFirst = !isFirst;
        if (isFirst)
        {
            if (num > colors.length)
            {
                imgdata.data[(i-9)*2] = 255;
                imgdata.data[(i-9)*2+1] = 255;
                imgdata.data[(i-9)*2+2] = 255;
            }
            else
            {
                imgdata.data[(i-9)*2] = colors[num][0];
                imgdata.data[(i-9)*2+1] = colors[num][1];
                imgdata.data[(i-9)*2+2] = colors[num][2];
            }
            num = 0;
        }
    }
    baseImgData = imgdata;
    console.log("Done");
    ctx.putImageData(imgdata, 0, 0);
    refreshMap();
    baseImgData = document.getElementById("MapCanvas").getContext("2d").getImageData(0, 0, __WIDTH, __HEIGHT);
}

function updateMap(response)
{
    if (response.length < 10)
    {
        return;
    }
    let mec = get32i(response, 0);
    console.log("mec" + mec.toString());
    let index = 4;
    for (;index < 4 + mec * 5; index += 5)
    {
        let x = get16i(response, index);
        let y = get16i(response, index + 2);
        baseImgData.data[(x + __WIDTH * y) * 4] = colors[response[index+4]][0];
        baseImgData.data[(x + __WIDTH * y) * 4 + 1] = colors[response[index+4]][1];
        baseImgData.data[(x + __WIDTH * y) * 4 + 2] = colors[response[index+4]][2];
    }
    let copyImgData = baseImgData;
    let antc = get16i(response, index);
    console.log("antc" + antc.toString());
    for (index = 6 + mec * 5; index < 6 + mec * 5 + antc * 4; index += 4)
    {
        let x = get16i(response, index);
        let y = get16i(response, index + 2);
        copyImgData.data[(x + __WIDTH * y) * 4] = antColor[0];
        copyImgData.data[(x + __WIDTH * y) * 4 + 1] = antColor[1];
        copyImgData.data[(x + __WIDTH * y) * 4 + 2] = antColor[2];
    }
    changelogPoint = get32i(response, index);
    console.log("clp" + changelogPoint.toString());
    setTimeout(refreshMap, 40);
}

function get32i(array, index)
{
    let num = 0;
    num += array[index];
    num *= 256;
    num += array[index + 1];
    num *= 256;
    num += array[index + 2];
    num *= 256;
    num += array[index + 3];
    return num;
}

function get16i(array, index)
{
    let num = 0;
    num += array[index];
    num *= 256;
    num += array[index + 1];
    return num;
}
        </script>
    </head>
    <body>
        <h1>AntGame!</h1>
        <p>Players in this game:</p>
        <ul id="PlayerList">
            None!
        </ul>
        <canvas id="MapCanvas" width="__WIDTH" height="__HEIGHT"></canvas>
    </body>
</html>
